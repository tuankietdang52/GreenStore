@page "/suppliers"
@using GreenStore.Clients
@using GreenStore.Shared.Pagination
@using GreenStore.Shared.Table
@using GreenStore.Pages.Supplier.Shared
@inject IGreenStoreApiClient Api
@inject ISnackbar Toast
@inject IDialogService DialogService

<PageTitle>Suppliers</PageTitle>

<div class="w-full h-full px-4 flex flex-col gap-4">
    <MudText Typo="@Typo.h4">
        Nhà cung cấp
    </MudText>

    <MudPaper Class="w-full flex! flex-col! gap-4">
        <div class="p-4! flex flex-wrap gap-4 items-center">
            <MudSelect T="SearchType" Value="searchType" ValueChanged="OnSearchTypeChanged"
                Label="Tìm theo" Variant="Variant.Outlined" Margin="Margin.Dense" 
                Style="width: 150px;">
                <MudSelectItem Value="SearchType.Name">Tên</MudSelectItem>
                <MudSelectItem Value="SearchType.Phone">Số điện thoại</MudSelectItem>
            </MudSelect>
            <MudTextField T="string" Value="searchValue" ValueChanged="OnSearchValueChanged" 
                Label="@GetSearchLabel()" Placeholder="@GetSearchPlaceholder()" Variant="Variant.Outlined" 
                Margin="Margin.Dense" Style="flex: 1; min-width: 200px;" Clearable="true" Adornment="Adornment.Start" 
                AdornmentIcon="@GetSearchIcon()" Immediate="true" 
                DebounceInterval="300" OnDebounceIntervalElapsed="OnSearchDebounced" />
            <MudButton Color="Color.Default" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" 
                OnClick="OnResetSearch" Style="height: 40px;">Đặt lại</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" 
                OnClick="OpenCreateDialog" Style="height: 40px;">Thêm</MudButton>
            <MudButton Color="Color.Error" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" 
                OnClick="OpenDeleteMultipleDialog" Style="height: 40px;" Disabled="@(!selectedItems.Any())">Xóa</MudButton>
        </div>
        @if (selectedItems.Any())
        {
            <div class="p-2 flex items-center gap-2">
                <MudText>Đã chọn @selectedItems.Count mục</MudText>
            </div>
        }
        <Table TModel="SupplierResponse" Props="tableProps" />
        <Pagination Props="paginationProps" OnPageChanged="OnPageChanged" OnPageSizeChanged="OnPageSizeChanged">
        </Pagination>
    </MudPaper>
</div>

@* Edit Dialog *@
<UpdateSupplierDialog @bind-IsVisible="isEditDialogVisible" Model="editModel" OnSubmit="SaveEdit" />

@* Create Dialog *@
<CreateSupplierDialog @bind-IsVisible="isCreateDialogVisible" Model="createModel" OnSubmit="SaveCreate" />

@* Delete Confirmation Dialog *@
<MudDialog @bind-Visible="isDeleteDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Xác nhận xóa</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Bạn có chắc chắn muốn xóa nhà cung cấp <strong>@selectedSupplier?.Name</strong>?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDeleteDialog">Hủy</MudButton>
        <MudButton Color="Color.Error" OnClick="ConfirmDelete">Xóa</MudButton>
    </DialogActions>
</MudDialog>

@* Delete Multiple Confirmation Dialog *@
<MudDialog @bind-Visible="isDeleteMultipleDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Xác nhận xóa nhiều</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Bạn có chắc chắn muốn xóa <strong>@selectedItems.Count</strong> nhà cung cấp đã chọn?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDeleteMultipleDialog">Hủy</MudButton>
        <MudButton Color="Color.Error" OnClick="ConfirmDeleteMultiple">Xóa</MudButton>
    </DialogActions>
</MudDialog>

@code {
    #region props and variables

    Response_PagedResponse_SupplierResponse? data;
    IEnumerable<SupplierResponse> items = [];
    bool isLoading = true;

    // Search
    enum SearchType { Name, Phone }
    SearchType searchType = SearchType.Name;
    string? searchValue;

    // Table props
    TableProps<SupplierResponse> tableProps = null!;

    PaginationProps paginationProps = new PaginationProps()
    {
        CurrentPage = 1,
        PageSize = 10,
        TotalPages = 0,
        Placement = GreenStore.Shared.Pagination.Placement.End
    };

    // Edit dialog
    bool isEditDialogVisible = false;
    SupplierDto editModel = new SupplierDto();

    // Create dialog
    bool isCreateDialogVisible = false;
    SupplierDto createModel = new SupplierDto();

    // Delete dialog
    bool isDeleteDialogVisible = false;
    SupplierResponse? selectedSupplier;

    // Multi-select
    HashSet<SupplierResponse> selectedItems = new HashSet<SupplierResponse>();
    bool isDeleteMultipleDialogVisible = false;

    #endregion

    protected override void OnInitialized()
    {
        InitializeTableProps();
    }

    private void InitializeTableProps()
    {
        tableProps = new TableProps<SupplierResponse>
        {
            Columns = new List<TableColumn<SupplierResponse>>
            {
                new TableColumn<SupplierResponse> { Header = "TÊN", ValueSelector = x => x.Name ?? "", SortSelector = x => x.Name ?? "" },
                new TableColumn<SupplierResponse> { Header = "SĐT", ValueSelector = x => x.Phone ?? "" },
                new TableColumn<SupplierResponse> { Header = "EMAIL", ValueSelector = x => x.Email ?? "" },
                new TableColumn<SupplierResponse> { Header = "ĐỊA CHỈ", ValueSelector = x => x.Address ?? "" }
            },
            Items = items,
            IsLoading = isLoading,
            IsSelectable = true,
            SelectedItems = selectedItems,
            SelectedItemsChanged = EventCallback.Factory.Create<ISet<SupplierResponse>>(this, OnSelectedItemsChanged),
            Actions = new List<TableAction<SupplierResponse>>
            {
                new TableAction<SupplierResponse>
                {
                    Icon = Icons.Material.Filled.Edit,
                    Text = "Chỉnh sửa",
                    Color = Color.Primary,
                    OnClick = OpenEditDialog
                }
            }
        };
    }

    private void UpdateTableProps()
    {
        tableProps.Items = items;
        tableProps.IsLoading = isLoading;
        tableProps.SelectedItems = selectedItems;
    }

    private void OnSelectedItemsChanged(ISet<SupplierResponse> items)
    {
        selectedItems = items as HashSet<SupplierResponse> ?? new HashSet<SupplierResponse>(items);
        StateHasChanged();
    }

    private string GetSearchLabel() => searchType switch
    {
        SearchType.Name => "Tìm theo tên",
        SearchType.Phone => "Tìm theo SĐT",
        _ => "Tìm kiếm"
    };

    private string GetSearchPlaceholder() => searchType switch
    {
        SearchType.Name => "Nhập tên...",
        SearchType.Phone => "Nhập số điện thoại...",
        _ => "Nhập từ khóa..."
    };

    private string GetSearchIcon() => searchType switch
    {
        SearchType.Name => Icons.Material.Filled.Search,
        SearchType.Phone => Icons.Material.Filled.Phone,
        _ => Icons.Material.Filled.Search
    };

    private async Task Fetch()
    {
        isLoading = true;
        UpdateTableProps();
        StateHasChanged();

        try
        {
            int curPage = paginationProps.CurrentPage;
            int pageSize = paginationProps.PageSize;

            string? searchName = searchType == SearchType.Name ? searchValue : null;
            string? searchPhone = searchType == SearchType.Phone ? searchValue : null;

            data = await Api.FilterSuppliersAsync(
                name: string.IsNullOrWhiteSpace(searchName) ? null : searchName,
                phone: string.IsNullOrWhiteSpace(searchPhone) ? null : searchPhone,
                pageNumber: curPage, 
                pageSize: pageSize);
            items = data?.Data?.Items ?? [];
            paginationProps.TotalPages = data?.Data?.TotalPages ?? 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Toast.Add("Không thể tải danh sách nhà cung cấp", Severity.Error);
        }

        isLoading = false;
        UpdateTableProps();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await Fetch();
    }

    private async void OnPageChanged(int page)
    {
        paginationProps.CurrentPage = page;
        await Fetch();
    }

    private async void OnPageSizeChanged(int pageSize)
    {
        paginationProps.PageSize = pageSize;
        await Fetch();
    }

    private void OnSearchTypeChanged(SearchType value)
    {
        searchType = value;
        searchValue = null;
        StateHasChanged();
    }

    private void OnSearchValueChanged(string value)
    {
        searchValue = value;
    }

    private async Task OnSearchDebounced(string value)
    {
        searchValue = value;
        paginationProps.CurrentPage = 1;
        selectedItems.Clear();
        await Fetch();
    }

    private async Task OnResetSearch()
    {
        searchValue = null;
        searchType = SearchType.Name;
        paginationProps.CurrentPage = 1;
        selectedItems.Clear();
        await Fetch();
    }

    #region Create

    private void OpenCreateDialog()
    {
        createModel = new SupplierDto();
        isCreateDialogVisible = true;
    }

    private async Task SaveCreate(SupplierDto model)
    {
        try
        {
            await Api.CreateSupplierAsync(model);
            Toast.Add("Thêm nhà cung cấp thành công", Severity.Success);
            isCreateDialogVisible = false;
            await Fetch();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Toast.Add("Không thể thêm nhà cung cấp", Severity.Error);
        }
    }

    #endregion

    #region Edit

    private void OpenEditDialog(SupplierResponse supplier)
    {
        editModel = new SupplierDto
        {
            SupplierId = supplier.SupplierId,
            Name = supplier.Name ?? "",
            Phone = supplier.Phone,
            Email = supplier.Email,
            Address = supplier.Address
        };
        isEditDialogVisible = true;
        StateHasChanged();
    }

    private async Task SaveEdit(SupplierDto model)
    {
        try
        {
            await Api.UpdateSupplierAsync(model.SupplierId, model);
            Toast.Add("Cập nhật nhà cung cấp thành công", Severity.Success);
            isEditDialogVisible = false;
            await Fetch();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Toast.Add("Không thể cập nhật nhà cung cấp", Severity.Error);
        }
    }

    #endregion

    #region Delete

    private void OpenDeleteDialog(SupplierResponse supplier)
    {
        selectedSupplier = supplier;
        isDeleteDialogVisible = true;
    }

    private void CloseDeleteDialog()
    {
        isDeleteDialogVisible = false;
        selectedSupplier = null;
    }

    private async Task ConfirmDelete()
    {
        if (selectedSupplier == null) return;

        try
        {
            await Api.DeleteSupplierAsync(selectedSupplier.SupplierId);
            Toast.Add("Xóa nhà cung cấp thành công", Severity.Success);
            CloseDeleteDialog();
            await Fetch();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Toast.Add("Không thể xóa nhà cung cấp", Severity.Error);
        }
    }

    private void OpenDeleteMultipleDialog()
    {
        if (!selectedItems.Any()) return;
        isDeleteMultipleDialogVisible = true;
    }

    private void CloseDeleteMultipleDialog()
    {
        isDeleteMultipleDialogVisible = false;
    }

    private async Task ConfirmDeleteMultiple()
    {
        if (!selectedItems.Any()) return;

        try
        {
            var deleteTasks = selectedItems.Select(s => Api.DeleteSupplierAsync(s.SupplierId));
            await Task.WhenAll(deleteTasks);
            
            Toast.Add($"Đã xóa {selectedItems.Count} nhà cung cấp thành công", Severity.Success);
            selectedItems.Clear();
            CloseDeleteMultipleDialog();
            await Fetch();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Toast.Add("Không thể xóa một số nhà cung cấp", Severity.Error);
        }
    }

    #endregion
}
