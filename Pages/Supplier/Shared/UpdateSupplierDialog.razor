@using GreenStore.Clients
@using System.ComponentModel.DataAnnotations

<MudDialog @bind-Visible="IsVisible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Chỉnh sửa nhà cung cấp</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="isValid">
            <MudTextField @bind-Value="Model.Name" Label="Tên" Required="true" 
                RequiredError="Tên không được để trống" Class="mt-3" />
            <MudTextField @bind-Value="Model.Phone" Label="SĐT" Required="true"
                RequiredError="SĐT không được để trống" Class="mt-3"
                Validation="@(new Func<string?, string?>(ValidatePhone))" />
            <MudTextField @bind-Value="Model.Email" Label="Email" Required="true"
                RequiredError="Email không được để trống" Class="mt-3" 
                InputType="InputType.Email"
                Validation="@(new Func<string?, string?>(ValidateEmail))" />
            <MudTextField @bind-Value="Model.Address" Label="Địa chỉ" Required="true"
                RequiredError="Địa chỉ không được để trống" Lines="2" Class="mt-3" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Hủy</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!isValid)">Lưu</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private DialogOptions dialogOptions = new DialogOptions
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    private MudForm form = null!;
    private bool isValid;

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public SupplierDto Model { get; set; } = new SupplierDto();

    [Parameter]
    public EventCallback<SupplierDto> OnSubmit { get; set; }

    private string? ValidatePhone(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return null;
        if (!System.Text.RegularExpressions.Regex.IsMatch(phone, @"^[0-9]{10,11}$"))
            return "SĐT phải có 10-11 chữ số";
        return null;
    }

    private string? ValidateEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email)) return null;
        if (!new EmailAddressAttribute().IsValid(email))
            return "Email không hợp lệ";
        return null;
    }

    private async Task Cancel()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(IsVisible);
    }

    private async Task Submit()
    {
        await form.Validate();
        if (isValid)
        {
            await OnSubmit.InvokeAsync(Model);
        }
    }
}
